import Tag from '../../../src/components/Tag'

# 如何理解PNPM多层项目文件的依赖关系
<Tag tag='PNPM'  />
pnpm 是一个高效的 monorepo 包管理器,它通过内容可寻址的方式来管理多层项目文件之间的依赖关系。以下是一些关键点:

## 基本介绍
1. **工作空间(Workspace)**
pnpm 使用工作空间的概念来组织多个相关项目。工作空间通常是一个包含多个包(package)的文件夹结构,每个包可以是一个库、应用程序或其他类型的模块。

2. **软链接(Symlink)**
pnpm 使用软链接来维护包之间的依赖关系。当一个包依赖于另一个包时,pnpm 会在 node_modules 中创建一个指向实际包位置的软链接,而不是复制整个包。这种方式大大提高了磁盘空间利用率和安装速度。

3. **全局存储(Global Store)**
pnpm 将所有包的不可变版本存储在一个全局存储位置中。当不同的工作空间依赖相同的包时,pnpm 会从全局存储区读取,从而避免重复下载和存储。这提高了磁盘利用效率。

4. **依赖关系解析**
pnpm 会分析工作空间中每个包的 package.json 文件,解析其依赖关系。根据依赖的版本范围,pnpm 会选择合适的包版本并创建软链接。如果存在版本冲突,pnpm 会尝试解析到一个兼容的版本。

5. **workspace.json**
在工作空间的根目录下,pnpm 使用 workspace.json 或 pnpm-workspace.yaml 文件来定义工作空间的结构和包之间的关系。这个文件指定了哪些文件夹是包,以及它们之间的依赖关系。

通过以上机制,pnpm 可以高效地管理多层项目之间的依赖,避免重复下载、节省磁盘空间,并提供了方便的依赖关系管理。在 monorepo 架构中,pnpm 提供了很好的开箱即用支持。
## 图形示例
```
                            +-----------------------+
                           |    Global Store       |
                           |  (Immutable Packages) |
                           +-----------------------+
                                       |
                                       |
                    +----------------------------------------+
                    |                Workspace                |
                    |          (pnpm-workspace.yaml)         |
                    |                                        |
                    |  +-------------+  +-------------+      |
                    |  |  Package A  |  |  Package B  |      |
                    |  | (Libraries) |  | (Application)|      |
                    |  +-------------+  +-------------+      |
                    |         |                 |            |
                    |         |                 |            |
                    |  +--------------+  +--------------+    |
                    |  | node_modules |  | node_modules |    |
                    |  |    (Symlinks)|  |    (Symlinks)|    |
                    |  +--------------+  +--------------+    |
                    +-----------------------------------------+
```

1. **Global Store** 存储了所有不可变的包版本,避免重复下载和存储。

2. **Workspace** 是一个包含多个相关项目(Package A 和 Package B)的文件夹结构。`pnpm-workspace.yaml` 文件定义了工作空间的结构和包之间的关系。

3. **Package A** 和 **Package B** 分别代表一个库项目和一个应用程序项目。

4. 每个包下的 `node_modules` 文件夹包含了指向 Global Store 中实际包位置的软链接,而不是完整的包副本。

5. 当 Package B 依赖于 Package A 时,pnpm 会在 Package B 的 `node_modules` 中创建一个指向 Package A 实际位置的软链接。

通过这种方式,pnpm 使用软链接和全局存储来有效管理多层项目文件之间的依赖关系,节省磁盘空间并提高安装速度。